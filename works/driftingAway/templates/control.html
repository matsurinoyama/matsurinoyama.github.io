<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Drifting Away ‚Äî Control Panel</title>
    <link rel="stylesheet" href="/static/css/styles.css?v={{ cache_bust }}" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+JP:wght@200;400;600&family=New+Tegomin&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="screen">
      <div class="control-panel">
        <h1>üéõ Control Panel</h1>

        <button class="btn" id="btn-start">‚ñ∂ Start Game</button>
        <button class="btn" id="btn-reveal">
          ‚è≠ Force Reveal (skip timer)
        </button>
        <button class="btn btn--danger" id="btn-reset">‚Ü∫ Reset Round</button>

        <div class="status-line" id="status">
          Phase: idle &nbsp;|&nbsp; Clients: 0
        </div>

        <div style="margin-top: 2rem; color: var(--fg-dim); font-size: 0.85rem">
          <p><strong>Screen URLs:</strong></p>
          <p>
            Player 1:
            <a href="/player/1" target="_blank" style="color: var(--p1)"
              >/player/1</a
            >
          </p>
          <p>
            Player 2:
            <a href="/player/2" target="_blank" style="color: var(--p2)"
              >/player/2</a
            >
          </p>
          <p>
            Spectator:
            <a href="/spectator" target="_blank" style="color: var(--accent)"
              >/spectator</a
            >
          </p>
        </div>

        <!-- Debug transcript panel -->
        <div class="debug-panel" style="margin-top: 2rem">
          <h2
            style="font-size: 1rem; margin-bottom: 0.5rem; color: var(--accent)"
          >
            üêõ Debug Transcripts
          </h2>
          <div
            id="debug-log"
            style="
              max-height: 360px;
              overflow-y: auto;
              font-family: &quot;JetBrains Mono&quot;, monospace;
              font-size: 0.78rem;
              line-height: 1.5;
              background: #f5f5f5;
              border: 1px solid #e0e0e0;
              border-radius: 8px;
              padding: 0.75rem;
            "
          >
            <p style="color: var(--fg-dim)">Waiting for speech‚Ä¶</p>
          </div>
          <button
            class="btn"
            id="btn-clear-log"
            style="
              margin-top: 0.5rem;
              font-size: 0.75rem;
              padding: 0.3rem 0.8rem;
            "
          >
            Clear log
          </button>
        </div>
      </div>
    </div>

    <script src="/static/js/common.js?v={{ cache_bust }}"></script>
    <script>
      const socket = new DriftSocket("control");

      const $status = document.getElementById("status");
      const $start = document.getElementById("btn-start");
      const $reveal = document.getElementById("btn-reveal");
      const $reset = document.getElementById("btn-reset");

      $start.addEventListener("click", () =>
        socket.send({ action: "start_game" }),
      );
      $reveal.addEventListener("click", () =>
        socket.send({ action: "force_reveal" }),
      );
      $reset.addEventListener("click", () => socket.send({ action: "reset" }));

      socket.on("snapshot", (msg) => {
        $status.textContent = `Phase: ${msg.phase}  |  Timer: ${formatTime(
          msg.remaining || 0,
        )}`;
      });
      socket.on("phase", (msg) => {
        $status.textContent = `Phase: ${msg.phase}`;
      });
      socket.on("timer", (msg) => {
        $status.textContent = `Phase: conversation  |  Timer: ${formatTime(
          msg.remaining,
        )}`;
      });

      // ‚îÄ‚îÄ Debug transcript log ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const $debugLog = document.getElementById("debug-log");
      const $clearLog = document.getElementById("btn-clear-log");

      function escHtml(s) {
        const d = document.createElement("span");
        d.textContent = s;
        return d.innerHTML;
      }

      socket.on("debug_turn", (msg) => {
        // Remove placeholder if present
        const placeholder = $debugLog.querySelector("p");
        if (placeholder && placeholder.textContent.includes("Waiting")) {
          placeholder.remove();
        }

        const pColor = msg.player === 1 ? "var(--p1)" : "var(--p2)";
        const entry = document.createElement("div");
        entry.style.marginBottom = "0.6rem";
        entry.style.borderLeft = `3px solid ${pColor}`;
        entry.style.paddingLeft = "0.5rem";
        entry.innerHTML = `
          <div style="color:${pColor}; font-weight:600;">Player ${
            msg.player
          }</div>
          <div><span style="color:var(--fg-dim);">STT:</span> ${escHtml(
            msg.original,
          )}</div>
          <div><span style="color:var(--fg-dim);">LLM:</span> ${escHtml(
            msg.misheard,
          )}</div>
        `;
        $debugLog.appendChild(entry);
        $debugLog.scrollTop = $debugLog.scrollHeight;
      });

      $clearLog.addEventListener("click", () => {
        $debugLog.innerHTML =
          '<p style="color: var(--fg-dim);">Waiting for speech‚Ä¶</p>';
      });
    </script>
  </body>
</html>
