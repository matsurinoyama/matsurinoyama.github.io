<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é›¢ã‚Œã¦ã„ã â€” Control Panel</title>
    <link rel="stylesheet" href="/static/css/styles.css?v={{ cache_bust }}" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+JP:wght@200;400;600&family=New+Tegomin&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="screen">
      <div class="control-panel">
        <h1>ğŸ› ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«</h1>

        <button class="btn" id="btn-start">â–¶ ã‚²ãƒ¼ãƒ é–‹å§‹</button>
        <button class="btn" id="btn-reveal">
          â­ å¼·åˆ¶ãƒªãƒ“ãƒ¼ãƒ«ï¼ˆã‚¿ã‚¤ãƒãƒ¼ã‚¹ã‚­ãƒƒãƒ—ï¼‰
        </button>
        <button class="btn btn--danger" id="btn-reset">
          â†º ãƒ©ã‚¦ãƒ³ãƒ‰ãƒªã‚»ãƒƒãƒˆ
        </button>

        <!-- â”€â”€ Language toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div style="margin-top: 1.5rem">
          <p style="font-weight: 600; margin-bottom: 0.5rem">
            ğŸŒ è¨€èª / Language
          </p>
          <button class="btn" id="btn-lang-ja" style="margin-right: 0.5rem">
            æ—¥æœ¬èª
          </button>
          <button class="btn" id="btn-lang-en">English</button>
        </div>

        <div class="status-line" id="status">
          Phase: idle &nbsp;|&nbsp; Clients: 0
        </div>

        <div style="margin-top: 2rem; color: var(--fg-dim); font-size: 0.85rem">
          <p><strong>ã‚¹ã‚¯ãƒªãƒ¼ãƒ³URLï¼š</strong></p>
          <p>
            Player 1:
            <a href="/player/1" target="_blank" style="color: var(--p1)"
              >/player/1</a
            >
          </p>
          <p>
            Player 2:
            <a href="/player/2" target="_blank" style="color: var(--p2)"
              >/player/2</a
            >
          </p>
          <p>
            Spectator:
            <a href="/spectator" target="_blank" style="color: var(--accent)"
              >/spectator</a
            >
          </p>
        </div>

        <!-- Debug transcript panel -->
        <div class="debug-panel" style="margin-top: 2rem">
          <h2
            style="font-size: 1rem; margin-bottom: 0.5rem; color: var(--accent)"
          >
            ğŸ› ãƒ‡ãƒãƒƒã‚°ãƒ»ãƒˆãƒ©ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
          </h2>
          <div
            id="debug-log"
            style="
              max-height: 360px;
              overflow-y: auto;
              font-family: &quot;JetBrains Mono&quot;, monospace;
              font-size: 0.78rem;
              line-height: 1.5;
              background: #f5f5f5;
              border: 1px solid #e0e0e0;
              border-radius: 8px;
              padding: 0.75rem;
            "
          >
            <p style="color: var(--fg-dim)">ç™ºè©±ã‚’å¾…ã£ã¦ã„ã¾ã™â€¦</p>
          </div>
          <button
            class="btn"
            id="btn-clear-log"
            style="
              margin-top: 0.5rem;
              font-size: 0.75rem;
              padding: 0.3rem 0.8rem;
            "
          >
            ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢
          </button>
        </div>
      </div>
    </div>

    <script src="/static/js/i18n.js?v={{ cache_bust }}"></script>
    <script src="/static/js/common.js?v={{ cache_bust }}"></script>
    <script>
      const socket = new DriftSocket("control");

      const $status = document.getElementById("status");
      const $start = document.getElementById("btn-start");
      const $reveal = document.getElementById("btn-reveal");
      const $reset = document.getElementById("btn-reset");
      const $langJa = document.getElementById("btn-lang-ja");
      const $langEn = document.getElementById("btn-lang-en");

      $start.addEventListener("click", () =>
        socket.send({ action: "start_game" }),
      );
      $reveal.addEventListener("click", () =>
        socket.send({ action: "force_reveal" }),
      );
      $reset.addEventListener("click", () => socket.send({ action: "reset" }));

      // â”€â”€ Language toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      $langJa.addEventListener("click", () =>
        socket.send({ action: "set_language", language: "ja" }),
      );
      $langEn.addEventListener("click", () =>
        socket.send({ action: "set_language", language: "en" }),
      );

      function updateLangButtons(lang) {
        $langJa.style.opacity = lang === "ja" ? "1" : "0.5";
        $langEn.style.opacity = lang === "en" ? "1" : "0.5";
      }
      updateLangButtons("ja"); // default

      socket.on("language_change", (msg) => {
        i18n.setLang(msg.language);
        updateLangButtons(msg.language);
      });

      socket.on("snapshot", (msg) => {
        $status.textContent = `Phase: ${msg.phase}  |  Timer: ${formatTime(
          msg.remaining || 0,
        )}`;
        if (msg.language) {
          i18n.setLang(msg.language);
          updateLangButtons(msg.language);
        }
      });
      socket.on("phase", (msg) => {
        $status.textContent = `Phase: ${msg.phase}`;
      });
      socket.on("timer", (msg) => {
        $status.textContent = `Phase: conversation  |  Timer: ${formatTime(
          msg.remaining,
        )}`;
      });

      // â”€â”€ Debug transcript log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const $debugLog = document.getElementById("debug-log");
      const $clearLog = document.getElementById("btn-clear-log");

      function escHtml(s) {
        const d = document.createElement("span");
        d.textContent = s;
        return d.innerHTML;
      }

      socket.on("debug_turn", (msg) => {
        // Remove placeholder if present
        const placeholder = $debugLog.querySelector("p");
        if (placeholder && placeholder.textContent.includes("å¾…ã£ã¦")) {
          placeholder.remove();
        }
        if (placeholder && placeholder.textContent.includes("Waiting")) {
          placeholder.remove();
        }

        const pColor = msg.player === 1 ? "var(--p1)" : "var(--p2)";
        const entry = document.createElement("div");
        entry.style.marginBottom = "0.6rem";
        entry.style.borderLeft = `3px solid ${pColor}`;
        entry.style.paddingLeft = "0.5rem";
        entry.innerHTML = `
          <div style="color:${pColor}; font-weight:600;">Player ${
            msg.player
          }</div>
          <div><span style="color:var(--fg-dim);">STT:</span> ${escHtml(
            msg.original,
          )}</div>
          <div><span style="color:var(--fg-dim);">LLM:</span> ${escHtml(
            msg.misheard,
          )}</div>
        `;
        $debugLog.appendChild(entry);
        $debugLog.scrollTop = $debugLog.scrollHeight;
      });

      $clearLog.addEventListener("click", () => {
        $debugLog.innerHTML =
          '<p style="color: var(--fg-dim);">ç™ºè©±ã‚’å¾…ã£ã¦ã„ã¾ã™â€¦</p>';
      });
    </script>
  </body>
</html>
